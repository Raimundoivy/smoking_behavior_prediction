{% extends "base.html" %}

{% block title %}Smoking Behavior Prediction{% endblock %}

{% block content %}
    <div id="react-root"></div>

    <script>
        window.APP_CONFIG = {
            genders: {{ config.VALID_GENDERS | tojson }},
            maritalStatuses: {{ config.VALID_MARITAL_STATUSES | tojson }},
            qualifications: {{ config.VALID_QUALIFICATIONS | tojson }},
            nationalities: {{ config.VALID_NATIONALITIES | tojson }},
            ethnicities: {{ config.VALID_ETHNICITIES | tojson }},
            incomes: {{ config.VALID_INCOMES | tojson }},
            regions: {{ config.VALID_REGIONS | tojson }}
        };
    </script>

    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>

    {% raw %}
    <script type="text/babel">
        const { useState, useEffect } = React;
        // NOTE: We have removed Framer Motion for stability.
        
        const FeatureImportance = ({ features }) => {
            const positiveFactors = features.filter(f => f.direction === 'positive');
            const negativeFactors = features.filter(f => f.direction === 'negative');
            const maxContribution = Math.max(...features.map(f => Math.abs(f.contribution)));
            const Factor = ({ factor }) => {
                const barWidth = maxContribution > 0 ? (Math.abs(factor.contribution) / maxContribution) * 100 : 0;
                const icon = factor.direction === 'positive' ? ( <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" className="bi bi-arrow-up-circle-fill text-danger" viewBox="0 0 16 16"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-7.5 3.5a.5.5 0 0 0 1 0V5.707l2.146 2.147a.5.5 0 0 0 .708-.708l-3-3a.5.5 0 0 0-.708 0l-3 3a.5.5 0 1 0 .708.708L7.5 5.707V11.5z"/></svg> ) : ( <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" className="bi bi-arrow-down-circle-fill text-success" viewBox="0 0 16 16"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM8.5 4.5a.5.5 0 0 0-1 0v5.793l-2.146-2.147a.5.5 0 0 0-.708.708l3 3a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V4.5z"/></svg> );
                return ( <li className="factor-item"><div className="factor-narrative">{icon}{factor.narrative}</div><div className="factor-bar-container"><div className="factor-bar" style={{ width: `${barWidth}%`, backgroundColor: factor.direction === 'positive' ? '#dc3545' : '#198754' }}></div></div></li> );
            };
            return ( <div className="mt-4"><h5>Key Prediction Factors</h5><div className="row"><div className="col-md-6"><h6>Factors Increasing Risk</h6>{positiveFactors.length > 0 ? ( <ul className="factor-list">{positiveFactors.map((f, i) => <Factor key={i} factor={f} />)}</ul> ) : (<p className="text-muted small">No significant risk factors found.</p>)}</div><div className="col-md-6"><h6>Factors Decreasing Risk</h6>{negativeFactors.length > 0 ? ( <ul className="factor-list">{negativeFactors.map((f, i) => <Factor key={i} factor={f} />)}</ul> ) : (<p className="text-muted small">No significant protective factors found.</p>)}</div></div></div> );
        };
        const SkeletonLoader = () => ( <div className="card"><div className="card-body"><h5 className="card-title placeholder-glow"><span className="placeholder col-8"></span></h5><p className="card-text placeholder-glow"><span className="placeholder col-10"></span></p><div className="progress placeholder-glow" style={{height: '25px'}}><span className="placeholder col-12"></span></div><h5 className="card-title placeholder-glow mt-4"><span className="placeholder col-5"></span></h5><p className="card-text placeholder-glow"><span className="placeholder col-12"></span></p><p className="card-text placeholder-glow"><span className="placeholder col-12"></span></p></div></div>);

        const App = () => {
            const initialFormData = {age: '35', gender: window.APP_CONFIG.genders[0], marital_status: window.APP_CONFIG.maritalStatuses[0], highest_qualification: window.APP_CONFIG.qualifications[0], nationality: window.APP_CONFIG.nationalities[0], ethnicity: window.APP_CONFIG.ethnicities[0], gross_income: window.APP_CONFIG.incomes[0], region: window.APP_CONFIG.regions[0]};
            const [formData, setFormData] = useState(initialFormData);
            const [result, setResult] = useState(null);
            const [isLoading, setIsLoading] = useState(false);
            const [error, setError] = useState('');
            const [history, setHistory] = useState(() => { try { const saved = localStorage.getItem('predictionHistory'); return saved ? JSON.parse(saved) : []; } catch (e) { return []; } });
            const [globalInsights, setGlobalInsights] = useState([]);
            const [isInitial, setIsInitial] = useState(true);
            const handleChange = (e) => setFormData(prev => ({ ...prev, [e.target.name]: e.target.value }));
            const renderOptions = (options) => options.map(opt => <option key={opt} value={opt}>{opt}</option>);
            
            const runPrediction = async (e) => {
                if(e) e.preventDefault();
                setIsLoading(true); setError(''); if(isInitial) setIsInitial(false);
                try {
                    const response = await fetch('/predict', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ ...formData, age: parseInt(formData.age) }) });
                    if (!response.ok) { const errData = await response.json(); throw new Error(errData.error || `Service failed`); }
                    const data = await response.json();
                    setResult(data);
                    if (e) { setHistory(prev => [{ inputs: formData, result: data, id: Date.now() }, ...prev.slice(0, 3)]); }
                } catch (err) { setError(err.message || 'Could not retrieve prediction.'); console.error(err);
                } finally { setIsLoading(false); }
            };

            useEffect(() => {
                const fetchGlobalInsights = async () => { try { const res = await fetch('/global-importance'); const data = await res.json(); setGlobalInsights(data); } catch (e) { console.error("Could not fetch global insights"); }};
                fetchGlobalInsights();
            }, []);

            useEffect(() => { if (isInitial) return; const handler = setTimeout(() => runPrediction(), 500); return () => clearTimeout(handler); }, [formData]);
            useEffect(() => { localStorage.setItem('predictionHistory', JSON.stringify(history)); }, [history]);

            return (
                <div>
                    <h1 className="mt-5">Smoking Behavior Prediction</h1>
                    <div className="row mt-4">
                        <div className="col-lg-5">
                            <h4>Your Information</h4>
                            <form onSubmit={runPrediction} className="card p-4">
                                <div className="form-group mb-3"><label htmlFor="age" className="form-label">Age: {formData.age}</label><input type="range" name="age" id="age" className="form-range" min="16" max="100" value={formData.age} onChange={handleChange} /></div>
                                <div className="form-group mb-3"><label>Gender</label><select name="gender" className="form-control" value={formData.gender} onChange={handleChange}>{renderOptions(window.APP_CONFIG.genders)}</select></div>
                                <div className="form-group mb-3"><label>Marital Status</label><select name="marital_status" className="form-control" value={formData.marital_status} onChange={handleChange}>{renderOptions(window.APP_CONFIG.maritalStatuses)}</select></div>
                                <div className="form-group mb-3"><label>Highest Qualification</label><select name="highest_qualification" className="form-control" value={formData.highest_qualification} onChange={handleChange}>{renderOptions(window.APP_CONFIG.qualifications)}</select></div>
                                <div className="form-group mb-3"><label>Nationality</label><select name="nationality" className="form-control" value={formData.nationality} onChange={handleChange}>{renderOptions(window.APP_CONFIG.nationalities)}</select></div>
                                <div className="form-group mb-3"><label>Ethnicity</label><select name="ethnicity" className="form-control" value={formData.ethnicity} onChange={handleChange}>{renderOptions(window.APP_CONFIG.ethnicities)}</select></div>
                                <div className="form-group mb-3"><label>Gross Income</label><select name="gross_income" className="form-control" value={formData.gross_income} onChange={handleChange}>{renderOptions(window.APP_CONFIG.incomes)}</select></div>
                                <div className="form-group mb-3"><label>Region</label><select name="region" className="form-control" value={formData.region} onChange={handleChange}>{renderOptions(window.APP_CONFIG.regions)}</select></div>
                                <button type="submit" className="btn btn-primary w-100" disabled={isLoading}>{isLoading ? 'Predicting...' : 'Get Initial Prediction'}</button>
                            </form>
                            {globalInsights.length > 0 && <div className="mt-4 card"><div className="card-header small">Global Model Insights</div><ul className="list-group list-group-flush">{globalInsights.map((insight, i) => (<li key={i} className="list-group-item small">{insight.feature}</li>))}</ul></div>}
                        </div>
                        <div className="col-lg-7">
                            <h4>Prediction & Analysis</h4>
                            {error && <div className="alert alert-danger">{error}</div>}
                            {isLoading && <SkeletonLoader />}
                            {!isLoading && result && (
                                <div className="card p-4">
                                    <div className={`alert ${result.prediction === 1 ? 'alert-danger' : 'alert-success'}`}>{result.prediction === 1 ? 'Prediction: LIKELY to be a smoker.' : 'Prediction: NOT LIKELY to be a smoker.'}</div>
                                    <p>The predicted probability of being a smoker is: <strong>{(result.smoking_probability * 100).toFixed(1)}%</strong> <span className="badge bg-secondary">{result.confidence} Confidence</span></p>
                                    <div className="progress mb-3" style={{height: '25px'}}><div className="progress-bar" role="progressbar" style={{ width: `${result.smoking_probability * 100}%` }}></div></div>
                                    {result.feature_importance && <FeatureImportance features={result.feature_importance} />}
                                </div>
                            )}
                            {!isLoading && !result && !error && (<div className="card p-4 text-center text-muted h-100 d-flex justify-content-center align-items-center"><p>Your prediction and analysis will appear here.</p></div>)}
                        </div>
                    </div>
                    {history.length > 0 && (<div className="mt-5"><h4>Prediction History</h4><div className="list-group">{history.map((entry) => (<div key={entry.id} className="list-group-item"><div className="d-flex w-100 justify-content-between"><h6 className="mb-1">Prediction: {(entry.result.smoking_probability * 100).toFixed(0)}% Smoker ({entry.result.confidence})</h6><small>Age: {entry.inputs.age}</small></div><p className="mb-1 small text-muted">Income: {entry.inputs.gross_income}, Qualification: {entry.inputs.highest_qualification}</p></div>))}</div></div>)}
                </div>
            );
        };

        const container = document.getElementById('react-root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
    {% endraw %}
{% endblock %}